project:
  git_repository: 'https://github.com/chahat-sf/Yogesh_Digambar_Takwale.git'

  deploy:
    directory: '/home/yogeshdtakwale/htdocs/yogeshdtakwale.com'
    shared_directories: []

    before_commands:
      - 'export NPM_CONFIG_CACHE=$HOME/htdocs/yogeshdtakwale.com/shared/.npm-cache && mkdir -p $NPM_CONFIG_CACHE'
      - 'export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && nvm use 20 && cd {release_directory} && npm ci --loglevel=verbose'
      - 'export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && nvm use 20 && cd {release_directory} && npm run build'
      - >
        cd {release_directory} &&
        rm -rf .deploy_runtime &&
        mkdir -p .deploy_runtime &&
        cp -a .next .deploy_runtime/.next &&
        cp -a node_modules .deploy_runtime/node_modules &&
        cp -a package.json .deploy_runtime/package.json &&
        cp -a next.config.* .deploy_runtime/ 2>/dev/null || true &&
        cp -a public .deploy_runtime/public &&
        find . -mindepth 1 -maxdepth 1 ! -name ".deploy_runtime" -exec rm -rf {} \; &&
        cp -a .deploy_runtime/. . &&
        rm -rf .deploy_runtime &&
        chmod -R +x node_modules/.bin node_modules/next/dist/bin 2>/dev/null || true

    after_commands:
      - 'export NVM_DIR="$HOME/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && nvm use 20 && (pm2 restart "yogeshdtakwale-app" --update-env || pm2 start npm --name "yogeshdtakwale-app" --cwd {release_directory} -- start -- -p 3012 --hostname 0.0.0.0)'
      - 'pm2 save'
